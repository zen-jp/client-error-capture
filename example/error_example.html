<html>
  <head>
    <!-- エラーキャプチャライブラリを読み込み -->
    <script src="../js/client-error-capture.js"></script>

    <script>
      // 補助: cookie読取/削除
      function getCookie(name) {
        var m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()\[\]\\/+^])/g, '\\$1') + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
      }
      function deleteCookie(name) {
        document.cookie = name + '=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; SameSite=Lax';
      }

      // クライアントのデバイスID（例: localStorage/cookieから参照）
      function readDeviceId() {
        var key = (ClientErrorCapture && ClientErrorCapture.config && ClientErrorCapture.config.deviceIdStorageKey) || 'cec_device_id';
        var cookie = (ClientErrorCapture && ClientErrorCapture.config && ClientErrorCapture.config.deviceIdCookieName) || 'cec_did';
        try {
          var v = localStorage.getItem(key);
          if (v) return v;
        } catch (_) {}
        return getCookie(cookie);
      }

      // ClientErrorCaptureライブラリの初期化
      document.addEventListener("DOMContentLoaded", function () {
        try {
          var initialConfig = {
            logToConsole: true,
            logToServer: true,
            logServerUrl: "http://localhost:3000/api/log",
            appName: "ErrorSampleApp",
            environment: "local",
            // version: "1.0.0",
            maxStackLength: 1000,
            throttleTime: 500,
            customHeaders: {
              "X-API-Key": "demo-key",
              "X-Env": "local"
            },
            handlePromiseRejections: true,
            // 送信前に加工（予約語の混入や追加項目を付与して挙動確認）
            transformRequest: function (payload) {
              var next = Object.assign({}, payload);
              next.tag = 'will-be-removed';
              next.service = 'will-be-removed';
              if (!next.meta) next.meta = {};
              next.meta.additionalField = 'value';
              console.log('[transformRequest] before send:', next);
              return next;
            },
            samplingSetting: 1.0,
            // 送信時の拡張
            snakeCasePayload: true,
            schemaName: 'default',
            schemaVersion: '0.1',
            authKey: 'demo-key',
          };

          ClientErrorCapture.init(initialConfig);

          console.log("ClientErrorCaptureライブラリが正常に初期化されました");
          console.log("deviceId:", readDeviceId());
        } catch (e) {
          console.error("ClientErrorCaptureライブラリの初期化に失敗しました:", e);
        }
      });

      window.onload = function () {
        // テスト用のボタンを動的に追加
        var testButton = document.createElement("button");
        testButton.innerText = "エラーを発生させる";
        testButton.onclick = function () {
          // 意図的にキャッチされないエラーを発生させる
          throw new Error("ボタンクリックによる意図的なエラー");
        };
        document.body.appendChild(testButton);

        // 別のテスト用ボタン：存在しない関数を呼び出す
        var testButton2 = document.createElement("button");
        testButton2.innerText = "存在しない関数を呼び出す";
        testButton2.style.marginLeft = "10px";
        testButton2.onclick = function () {
          nonExistentFunction();
        };
        document.body.appendChild(testButton2);

        // 手動でエラーをキャプチャするテスト用ボタン
        var testButton3 = document.createElement("button");
        testButton3.innerText = "null参照エラー";
        testButton3.style.marginLeft = "10px";
        testButton3.onclick = function () {
          try {
            var obj = null;
            obj.property = "test"; // null参照エラー
          } catch (e) {
            // エラーを手動でキャプチャ（ソースコードの位置情報も含める）
            ClientErrorCapture.captureError(e, {
              context: "テスト用の手動キャプチャ",
              component: "Button3",
            });
          }
        };
        document.body.appendChild(testButton3);

        // Promise拒否エラーのテスト用ボタン
        var testButton4 = document.createElement("button");
        testButton4.innerText = "Promiseエラー";
        testButton4.style.marginLeft = "10px";
        testButton4.onclick = function () {
          // 意図的に拒否されるPromise
          new Promise(function (resolve, reject) {
            setTimeout(function () {
              reject(new Error("これは拒否されたPromiseのエラーです"));
            }, 100);
          });
        };
        document.body.appendChild(testButton4);

        // オプション切替/確認用のUI
        var sep = document.createElement('div');
        sep.style.marginTop = '12px';
        document.body.appendChild(sep);

        // デバイスID表示
        var showDid = document.createElement('button');
        showDid.innerText = 'デバイスIDを表示';
        showDid.style.marginLeft = '10px';
        showDid.onclick = function () {
          console.log('現在のdeviceId:', readDeviceId());
          alert('deviceId: ' + (readDeviceId() || '(取得できませんでした)'));
        };
        document.body.appendChild(showDid);

        // snake_case切替
        var toggleSnake = document.createElement('button');
        toggleSnake.innerText = 'snake_case変換 ON/OFF';
        toggleSnake.style.marginLeft = '10px';
        toggleSnake.onclick = function () {
          var cur = !!ClientErrorCapture.config.snakeCasePayload;
          ClientErrorCapture.updateConfig({ snakeCasePayload: !cur });
          console.log('snakeCasePayload:', !cur);
        };
        document.body.appendChild(toggleSnake);

        // schema付与切替
        var toggleSchema = document.createElement('button');
        toggleSchema.innerText = 'schema 付与 ON/OFF';
        toggleSchema.style.marginLeft = '10px';
        toggleSchema.onclick = function () {
          var enabled = !!ClientErrorCapture.config.schemaName;
          ClientErrorCapture.updateConfig({
            schemaName: enabled ? undefined : 'default',
            schemaVersion: enabled ? undefined : '0.1'
          });
          console.log('schema enabled:', !enabled);
        };
        document.body.appendChild(toggleSchema);

        // DNT尊重切替
        var toggleDnt = document.createElement('button');
        toggleDnt.innerText = 'DNT尊重 ON/OFF';
        toggleDnt.style.marginLeft = '10px';
        toggleDnt.onclick = function () {
          var cur = !!ClientErrorCapture.config.respectDoNotTrack;
          ClientErrorCapture.updateConfig({ respectDoNotTrack: !cur });
          console.log('respectDoNotTrack:', !cur);
        };
        document.body.appendChild(toggleDnt);

        // デバイスIDリセット（localStorage/cookie削除→リロード）
        var resetDid = document.createElement('button');
        resetDid.innerText = 'デバイスIDを削除して再生成';
        resetDid.style.marginLeft = '10px';
        resetDid.onclick = function () {
          try {
            var key = (ClientErrorCapture && ClientErrorCapture.config && ClientErrorCapture.config.deviceIdStorageKey) || 'cec_device_id';
            var cookie = (ClientErrorCapture && ClientErrorCapture.config && ClientErrorCapture.config.deviceIdCookieName) || 'cec_did';
            localStorage.removeItem(key);
            deleteCookie(cookie);
          } catch (_) {}
          alert('デバイスIDを削除しました。ページを再読み込みします。');
          location.reload();
        };
        document.body.appendChild(resetDid);
      };
    </script>
  </head>
  <body>
    <h1>エラーキャプチャテスト</h1>
    <p>このページは、グローバルなエラーキャプチャのテスト用です。</p>
    <p>コンソールを開いて（F12キー）、エラーメッセージを確認してください。</p>
    <p>
      3秒後に自動的にエラーが発生します。また、以下のボタンを使ってさまざまなエラーをテストできます。
    </p>
  </body>
</html>
